variables:
  SPEC: "thapi@develop+archive+test-dependencies"
  OPTS: "--concurrent-packages 2 -j32 --show-log-on-error --fail-fast"
  PROJ: "Performance"
  QUEUE: "prod"
  TIME: "2:00:00"
  WRK_DIR: "/lus/flare/projects/Performance/thapi"
  ANL_AURORA_SCHEDULER_PARAMETERS: "-q ${QUEUE} -l select=1,walltime=${TIME},filesystems=home -A ${PROJ}"

# NOTE: uses default stages: .pre build test deploy .post
stages:
    - .pre
    - build
    - test

setup:
  stage: .pre
  extends: .aurora-shell-runner
  script:
    # FIXME: For the time being we delete ${WRK_DIR}/${CI_COMMIT_SHA} if it exists.
    - rm -rf ${WRK_DIR}/${CI_COMMIT_SHA}
    - mkdir -p ${WRK_DIR}/${CI_COMMIT_SHA}
    - cd ${WRK_DIR}/${CI_COMMIT_SHA}
      # setup spack
    - git clone -c feature.manyFiles=true -b releases/latest https://github.com/spack/spack.git
    - . spack/share/spack/setup-env.sh
      # Isolate spack for CI (see below link):
      # https://spack.readthedocs.io/en/latest/configuration.html#overriding-local-configuration
    - export SPACK_DISABLE_LOCAL_CONFIG=true
    - export SPACK_USER_CACHE_PATH=/tmp/spack-${CI_COMMIT_SHA}
    - module load oneapi
    - spack compiler find
      # find external packages known to spack (avoid bzip2 and xz since they cause
      # build failures in elfutils).
    - spack external find --all --exclude bzip2 --exclude xz
      # setup THAPI-spack
    - git clone https://github.com/argonne-lcf/THAPI-spack.git
    - cd ./THAPI-spack
    - git checkout ${CI_COMMIT_SHA}
    - spack repo add .

install:
  stage: build
  extends: .aurora-batch-runner
  script:
    - cd ${WRK_DIR}/${CI_COMMIT_SHA}
    - export SPACK_DISABLE_LOCAL_CONFIG=true
    - export SPACK_USER_CACHE_PATH=/tmp/spack-${CI_COMMIT_SHA}
    - . spack/share/spack/setup-env.sh
    - spack install ${OPTS} ${SPEC}

integration_tests:
  stage: test
  extends: .aurora-batch-runner
  script:
    - cd ${WRK_DIR}/${CI_COMMIT_SHA}
    - export SPACK_DISABLE_LOCAL_CONFIG=true
    - export SPACK_USER_CACHE_PATH=/tmp/spack-${CI_COMMIT_SHA}
    - . spack/share/spack/setup-env.sh
    - spack load ${SPEC}
    - git clone https://github.com/argonne-lcf/THAPI.git -b devel
    - cd ./THAPI
    - module load oneapi
    - bats ./integration_tests/
